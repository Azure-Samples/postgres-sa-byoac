# 1.4 提供されるアーティファクト

このセクションでは、ソリューションアクセラレータで使用されるテーブルスキーマとデータアーティファクト（例：SOWドキュメント、請求書、検証結果）の概要を提供します。AIによる処理を可能にする**主要なフィールド**を強調し、Azure AIサービスが特定のフィールドを使用する理由を説明します。

??? question "独自のデータを使用しますか？"

    アクセラレータを**独自のデータに適応させる**場合、既存のデータベーススキーマやデータ構造に合わせて変更が必要になることがあります。

    1. データを既存のスキーマにマッピングする

          - `sows`、`invoices`、`vendors`に**対応するテーブルを特定**します。
          - データが`sow_chunks`のように**分割され処理される**ことを確認します。
          - コアテーブル構造を変更せずに、追加データを動的に保存するために**JSONB**カラムを活用します。

    2. AI検索を可能にするためにベクトル埋め込みを追加する

          - AI生成の埋め込みを保存するために、関連するテーブルに**ベクトルカラム（`embedding`）**を作成します。
          - 効率的なAI検索のために**pg_diskann**を使用します。

    3. AI処理スクリプトを修正する

          - フィールド名に合わせて**データ抽出スクリプト**を更新します。
          - AIモデルがスキーマに基づいて**正しいエンティティを抽出**することを確認します。

    4. グラフデータのエクスポートと関係を更新する

          - **テーブル構造に合わせて**データエクスポートスクリプトを修正します。
          - データベース内のエンティティを正しくリンクする**グラフ関係**を確認します。

---

## テーブルスキーマの理解

アクセラレータは、**作業指示書（SOW）、請求書、検証結果、抽出されたエンティティ**を構造化されたPostgreSQLスキーマを使用して処理します。以下は、**主要なテーブル**とその役割の概要です：

### コアテーブルとその目的

| **テーブル**                | **説明** |
|-----------------------------|-----------------------------------------------------------|
| `vendors`                   | ベンダーの詳細を保存し、関連するSOWや請求書にリンクします。 |
| `status`                    | システム内の異なるエンティティの状態を追跡するために使用される様々なステータス値を保存します。 |
| `sows`                      | 作業指示書に関する情報を含み、条件、関係者、成果物を含みます。 |
| `sow_chunks`                | SOWドキュメントをAI処理のために小さなセクションに分割します。 |
| `milestones`                | SOWから抽出された契約上のマイルストーンを追跡します。 |
| `deliverables`              | SOWで定義された主要な成果物の詳細を記載します。 |
| `invoices`                  | 金額、支払期日、関連するSOWなどの請求書の詳細を含みます。 |
| `invoice_line_items`        | 請求書から抽出された個々の項目を保存します。 |
| `invoice_validation_results`| 請求書の正確性と不一致に関するAI駆動の検証を保存します。 |
| `sow_validation_results`    | SOWのコンプライアンスと一貫性に関するAI駆動の検証結果を保存します。 |
| `copilot_chat_sessions`     | 個々のチャットセッションに関する情報を保存します。 |
| `copilot_chat_session_history` | チャットセッション中に交換されたメッセージの履歴を保存します。 |

### これらのテーブルがどのように連携するか

1. **SOW ドキュメント**は処理され、構造化されたチャンクに分割されます。
2. AI サービスが主要なエンティティ（**ベンダー、成果物、マイルストーン**）を抽出します。
3. 抽出された情報は検証され、**検証テーブル**に保存されます。
4. **請求書**は契約遵守チェックのために**SOW**にリンクされます。

---

## AI 処理で使用される主要フィールド

このソリューションアクセラレータは、情報を抽出、検証、処理するために**Azure AI サービス**と統合されています。以下は、AI ワークフローで役割を果たす**主要フィールド**と、それらが選ばれた理由です。

### AI サービスで使用されるリレーショナルフィールド

| **フィールド名**              | **テーブル**                  | **AI の使用法** |
|----------------------------|---------------------------|-------------------------------------------|
| `content`             | `sow_chunks`, `invoices`             | AI はこのフィールドを処理して、生のテキストから構造化データを抽出します。 |
| `embedding`         | `deliverables`, `sow_chunks`, `invoice_line_items`, `invoice_validation_results`, `sow_validation_results` | **セマンティック検索モデル**でのベクトル検索と類似性検索に使用されます。 |
| `due_date`       | `deliverables`, `invoice_line_items`              | AI は締め切りを抽出し、検証することができます。 |
| `amount`            | `invoices`                | AI は請求書の詳細の不一致を抽出し、検出します。 |
|`result`            | `sow_validation_results`, `invoice_validation_results`    | 処理されたドキュメントのコンプライアンスに関する AI 生成の分析 |
| `validation_passed`        | `sow_validation_results`, `invoice_validation_results` | コンプライアンス分析のための AI 駆動の検証結果。 |
| `metadata`                 |`invoices`                | 動的な AI 生成の洞察を保存するための JSONB カラム。 |

### グラフ関係

| **フィールド名**              | **グラフ**                  | **AI の使用法** |
|-------------------------------|---------------------------------|--------------------------------------|
|`vendor_id`,`vendor_name`   |    `vendor_graph`    |    ベンダーのパフォーマンスと関係を分析するために使用されます    |
|`sow_id`,`sow_number`       |    `vendor_graph`       |    作業指示書 (SOW) を追跡し、検証するために使用されます    |
|`payment_status`,`invoice_amount`    |    `vendor_graph`    | 請求書を検証および処理し、不一致を検出し、コンプライアンスを確保するために使用されます。    |

### なぜこれらのフィールドが重要なのか

- **ベクトル埋め込み (`embedding`)** は、SOW条項、契約条件、請求書の類似性をAIによって検索する**セマンティック検索**を可能にします。
- **検証フィールド (`result`, `validation_passed`)** は、AIが生成した抽出結果がビジネスルールを満たしていることを確認します。
- `vendor_graph` 内の**グラフ関係**は、ベンダー、契約、請求書に関連する分析やAIの精度向上のために選択されたフィールドをAIモデルで利用できる**GraphRAG (Retrieval-Augmented Generation)** をサポートします。

---

## JSONBを使用したスキーマの拡張

PostgreSQLの**JSONB**データ型は、半構造化データを保存およびクエリするための強力な方法を提供し、多様で進化するデータセットを扱う柔軟性を必要とするAI駆動のアプリケーションに最適です。AIサービスは急速に変化するスキーマ、さまざまなデータ形式、非構造化メタデータを扱うことが多いです。**JSONB**は、これらのサービスが厳格なスキーマ変更を行わずに追加のデータポイントを統合することを可能にし、スケールでの適応性とパフォーマンスを保証します。

### AIサービスにJSONBが理想的な理由

- **スキーマの進化**: AIアプリケーションは、新しい機能、モデル、メタデータを頻繁に導入します。JSONBは、既存のリレーショナル構造を乱すことなく**シームレスなスキーマ変更**を可能にします。
- **非構造化データの処理**: 多くのAIワークロードは、**センサーデータ、ユーザーインタラクション、埋め込み、モデル予測**を取り込み、これらは従来のリレーショナルカラムに収まりません。
- **効率的なインデックス作成とクエリ**: JSONBは、**GIN (Generalized Inverted Index)** と**JSONPathクエリ**をサポートし、ネストされたデータの検索を迅速かつ効率的に行います。
- **コンパクトなストレージと高速な取得**: プレーンなJSONとは異なり、JSONBは**バイナリ最適化**されており、大量のデータを処理するAIパイプラインでのオーバーヘッドを削減します。

### AI駆動のメタデータとモデル出力にJSONBを使用する

PostgreSQLをバックエンドとするシステムにAIサービスを統合する際、JSONBを活用して以下を保存できます：

- **推論結果**（例：確率、分類、埋め込み）。
- **モデルメタデータ**（例：ハイパーパラメータ、トレーニング設定）。
- **特徴抽出の詳細**（例：NLPトークン化された単語、ベクトル埋め込み）。
- **リアルタイムのユーザーインタラクション**（例：チャット履歴、イベントトラッキング）。

### JSONBクエリのためのインデックス追加

GIN（Generalized Inverted Index）は、PostgreSQLにおけるインデックスの一種で、JSONBを含む複雑なデータ型の処理に最適化されています。JSONBはデータをバイナリ形式で保存し、豊富なクエリをサポートするため、GINインデックスを使用することで、ネストされたJSONB構造内を効率的に検索することが可能です。

**GINの利点:**

- 高速なクエリ性能: GINはJSONBカラム内のキーと値の検索を大幅に高速化します。
- ネストされた構造に最適化: 深くネストされたJSONオブジェクトや配列を効率的にインデックス化できます。
- JSONBオペレーターをサポート: PostgreSQLは、GINと組み合わせて使用することで最適化される強力なオペレーター（@>, ?, ?&, ?|）を提供します。

### 使用例

```sql
ALTER TABLE invoices ADD COLUMN metadata JSONB;

-- Insert data into the JSONB column
UPDATE invoices
SET metadata = '{"additional_info": "value", "extra_field": 123}'
WHERE id = 1;

-- Create a GIN index on the JSONB column
CREATE INDEX idx_invoices_metadata ON invoices USING GIN (metadata);

-- Query the record based on one of the JSONB elements
SELECT * FROM invoices
WHERE metadata @> '{"extra_field": 123}';
```

!!! note "オペレーター `@>` は、model_outputが指定されたJSONのキーと値のペアを含んでいるかどうかをチェックします。"

JSONBを活用することで、AIサービスはデータ構造を効率的に保存、取得、進化させることができます。このアプローチにより、新しいAI駆動の洞察、特徴抽出、モデル出力をシステムに組み込む際に、厳格なスキーマ変更を必要とせず、最終的にPostgreSQL環境内でのAIソリューションの展開とスケーリングを加速します。

### JSONB学習リソース

- [AIサービスとデータの概要](https://techcommunity.microsoft.com/blog/adforpostgresql/azure-postgresql-with-azure-open-ai-to-innovate-banking-apps-unlocking-the-power/4257561)
- [PostgreSQL JSONBドキュメント](https://www.postgresql.org/docs/current/datatype-json.html)
- [JSONBとインデックス](https://www.postgresql.org/docs/current/datatype-json.html)
- [JSONBとGINインデックス](https://www.postgresql.org/docs/current/gin.html)
